/* eslint-env browser */

/* global ciscospark, React, ReactDOM */

/* eslint-disable camelcase */
/* eslint-disable max-nested-callbacks */
/* eslint-disable no-alert */
/* eslint-disable no-console */
/* eslint-disable require-jsdoc */
/* eslint-disable no-unused-expressions */

// Declare some globals that we'll need throughout
let spark;

class App extends React.Component { // eslint-disable-line no-unused-vars
  state = {
    accessToken: localStorage.getItem('access-token') || '',
    authenticated: false,
    connected: false,
    connectAddress: 'roomkit@sparkdemos.com',
    meeting: null,
    videoBox: false,
    sendAudio: true,
    sendVideo: true,
    recieveAudio: true,
    recieveVideo: true,
    screenshare: false
  };

  localMedia = React.createRef();

  remoteMedia = React.createRef();

  screenShareMedia = React.createRef();

  authenticate = (e) => {
    e.preventDefault();

    window.teams = spark = ciscospark.init({
      // eslint-disable-line no-multi-assign
      config: {
        // Any other sdk config we need
      },
      credentials: {
        access_token: this.state.accessToken
      }
    });

    if (!spark.internal.device.registered) {
      spark.internal.device
        .register()
        .then(() => {
          // This is just a little helper for our selenium tests and doesn't
          // really matter for the example
          document.body.classList.add('listening');
          this.setState({
            authenticated: true
          });
          localStorage.setItem('access-token', this.state.accessToken);
          // return this.spark.internal.device.register()
          return spark.internal.mercury.connect();
        })
        // This is a terrible way to handle errors, but anything more specific is
        // going to depend a lot on your app
        .catch((err) => {
          console.error(err);
          // we'll rethrow here since we didn't really *handle* the error, we just
          // reported it
          throw err;
        });
    }
  };

  connect = (e) => {
    e.preventDefault();

    spark.meetings.create(this.state.connectAddress).then((meeting) => {
      meeting.on('media:ready', (media) => {
        if (media.type === 'local') {
          this.localMedia.current.srcObject = media.stream;
        }

        if (media.type === 'remote') {
          this.remoteMedia.current.srcObject = media.stream;
        }
      });

      // meeting.join();

      meeting.join({
        mediaDirection: {
          sendAudio: this.state.sendAudio,
          sendVideo: this.state.sendVideo,
          receiveAudio: this.state.recieveAudio,
          receiveVideo: this.state.recieveVideo,
          pstn: false,
          sendShare: false,
          receiveShare: false
        }
      });

      this.setState({
        meeting,
        connected: true,
        videoBox: true
      });
    });
  };

  disconnect = (e) => {
    e.preventDefault();

    this.state.meeting.leave();

    this.localMedia.current.srcObject = null;
    this.remoteMedia.current.srcObject = null;
    this.screenShareMedia.current.srcObject = null;

    this.setState({
      meeting: null,
      videoBox: false
    });
  };

  setConnectAddress = (address) => {
    this.setState({
      connectAddress: address
    });
  };

  setToken = (token) => {
    this.setState({
      accessToken: token
    });
  };

  render() {
    return (
      <div className="row">
        <header className="page-header">
          <h1 className="page-header_title">Meetings Kitchen Sink</h1>
          <p className="page-header_lead">
            This is the start of the "kitchen sink" demo app for plugin-meetings.
          </p>
        </header>
        <section className="row">
          <h2>Connect first:</h2>
          <form onSubmit={(e) => this.authenticate(e)}>
            <fieldset>
              <legend>Credentials</legend>
              <div className="cui-input-group medium-3 columns" style={{paddingRight: '1rem'}}>
                <input
                  className="cui-input"
                  name="accessToken"
                  placeholder="Your access token"
                  onChange={(e) => this.setToken(e.target.value)}
                  type="text"
                  value={this.state.accessToken}
                />
                <p className="cui-input__help-text">{this.state.authenticated ? 'connected' : 'disconnected'}</p>
              </div>
              <button className="cui-button" type="submit">connect</button>
            </fieldset>
          </form>
        </section>
        {
          // <section>
          //   <h2>Then click:</h2>
          //     <fieldset>
          //       <legend>Meeting Controls</legend>
          //       <button className="cui-button"
          //         id="meetings-object"
          //         title="meetings object"
          //         type="button"
          //         onClick={(e) => {
          //           e.preventDefault();
          //           if (this.state.meetings) console.log(this.state.meetings);
          //         }}
          //       >
          //         Meetings
          //       </button>
          //     </fieldset>
          // </section>
        }
        <section className="row">
          <h2>Call Controls</h2>
          <fieldset>
            <legend>Controls</legend>
            <div className="row">
              <div className="cui-input-group cui-checkbox medium-2 columns">
                <input
                  className="cui-input cui-checkbox__input"
                  name="Show Video"
                  type="checkbox"
                  checked={this.state.sendVideo}
                  onChange={() => {
                      this.state.meeting && this.state.sendVideo
                        ? this.state.meeting.startSendingVideo()
                        : this.state.meeting.stopSendingVideo();

                    this.setState({sendVideo: !this.state.sendVideo});
                  }}
                />
                <label className="cui-checkbox__label">
                  <span>Send Video</span>
                </label>
              </div>
              <div className="cui-input-group cui-checkbox medium-2 columns">
                <input
                className="cui-input cui-checkbox__input"
                name="Show Audio"
                type="checkbox"
                checked={this.state.sendAudio}
                onChange={() => {
                  this.state.meeting && this.state.sendAudio
                    ? this.state.meeting.startSendingAudio()
                    : this.state.meeting.stopSendingAudio();

                  this.setState({sendAudio: !this.state.sendAudio});
                }}
                />
                <label className="cui-checkbox__label">
                  Send Audio
                </label>
              </div>
              <div className="cui-input-group cui-checkbox medium-2 columns end">
                <input
                className="cui-input cui-checkbox__input"
                name="Screenshare"
                type="checkbox"
                checked={this.state.screenshare}
                onChange={() =>
                  this.setState({screenshare: !this.state.screenshare})
                }
                />
                <label className="cui-checkbox__label">
                  Screenshare
                </label>
              </div>
            </div>
            <div className="row">
              <div className="cui-input-group cui-checkbox medium-2 columns">
                <input
                className="cui-input cui-checkbox__input"
                name="Recieve Video"
                type="checkbox"
                checked={this.state.recieveVideo}
                onChange={() =>
                  this.setState({recieveVideo: !this.state.recieveVideo})
                }
                />
                <label className="cui-checkbox__label">
                  Recieve Video
                </label>
              </div>
              <div className="cui-input-group cui-checkbox medium-2 columns end">
                <input
                className="cui-input cui-checkbox__input"
                name="Recieve Audio"
                type="checkbox"
                checked={this.state.recieveAudio}
                onChange={() =>
                  this.setState({recieveAudio: !this.state.recieveAudio})
                }
                />
                <label className="cui-checkbox__label">
                  Recieve Audio
                </label>
              </div>
            </div>
          </fieldset>
        </section>
        <section className="row">
          <h2>Dialer:</h2>
          <form
            onSubmit={(e) =>
              (this.state.connected && this.state.videoBox ? this.disconnect(e) : this.connect(e))
            }
          >
            <fieldset>
              <legend>Dialer</legend>
              <div className="cui-input-group medium-3 columns" style={{paddingRight: '1rem'}}>
                <input
                  className="cui-input"
                  id="invitee"
                  name="invitee"
                  type="text"
                  onChange={(e) => this.setConnectAddress(e.target.value)}
                  value={this.state.connectAddress}
                />
              </div>
              <button className="cui-button" type="submit" disabled={!this.state.authenticated}>
                {this.state.connected && this.state.videoBox ? 'disconnect' : 'connect'}
              </button>
            </fieldset>
          </form>
        </section>
        {this.state.videoBox && (
          <div className="row">
            <div className="row">
              <div className="medium-6 columns">
                <video
                  autoPlay
                  playsInline
                  id="localvideo"
                  ref={this.localMedia}
                />
              </div>
              <div className="medium-6 columns">
              <video
                autoPlay
                playsInline
                id="remotevideo"
                ref={this.remoteMedia}
              />
              </div>
            </div>
            <div className="row">
              <div className="medium-6 medium-centered columns">
                <video
                  autoPlay
                  playsInline
                  id="screenshare"
                  ref={this.screenShareMedia}
                  style={{height: '500px', width: '500px'}}
                />
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }
}

ReactDOM.render(<App />, document.getElementById('root'));
